{% extends "public/base.html" %}
{% load staticfiles %}
{% load markdownify %}

{% block page_title %}Badge Assertion Detail{% endblock %}

{% block extra_head %}
	{% if badge_instance and badge_class and issuer %}
        <meta property="og:type"               content="website" />
        <meta property="og:url"                content="{{ badge_instance_public_url }}" />
        <meta property="og:title"              content="{{ badge_class.name }}" />
        <meta property="og:description"        content="{{ badge_class.description }}" />

        <meta property="og:image"              content="{{ badgeclass_image_png }}" />
        <meta property="og:image:secure_url"   content="{{ badgeclass_image_png }}" />

        <meta property="og:site_name"          content="Badgr" />
	{% endif %}
{% endblock %}

{% block content %}
	{% if not badge_instance or not badge_class or not issuer %}
		<article class="emptyillustration" *ngIf="! issuers.length">
			<img srcset="{% static 'badgr-ui/images/500-badgr-2x.png' %} 2x, {% static 'badgr-ui/images/500-badgr.png' %}"src="{% static 'badgr-ui/images/500-badgr.png' %}"alt="Badgr is sorry :(" width="312" height="317">
			<p>The Badge you are looking for could not be found.</p>
		</article>
	{% elif badge_instance.revoked %}
		<div class="wrap wrap-light l-containerhorizontal l-heading">
			<p>This badge has been revoked. {{ badge_instance.revocation_reason }}</p>
		</div>
	{% else %}
    <header class="wrap wrap-light l-containerhorizontal l-heading">

	    <div class="heading">

            <div>
                <div class="heading-x-imageLarge">
                    <img src="{{badge_instance_image_url}}" alt="{{badge_class.name}}">
                </div>
                <aside class="heading-x-aside">
                    <div>
                        <div class="new">NEW!</div> <strong>Versions</strong>
                    </div>
                    {%  if obi_version == "1_1" %}
                        <p>
                            Badgr is testing the new version of Open Badges.
                        </p>
                        <p>
                            Badges accessed or downloaded in 2.0 format may not yet be accepted everywhere Open Badges are used.
                        </p>
                    {% endif %}
                    <a href="{{alt_url}}"><strong>View {{alt_version_name}} Version</strong></a>
                </aside>
            </div>
		    <div class="heading-x-text">

			    <h1>{{ badge_class.name }}</h1>

            	<a class="stack" href="{{ issuer_url }}">
				    <div class="stack-x-image">
					    <img src="{% if issuer.image %}{{ issuer.image.url }}{% else %}{% static 'badgr-ui/images/issuer-placeholder.png' %}{% endif %}"
					         width="40"
					         alt="{{ issuer.name }}" />
				    </div>
				    <div class="stack-x-text">
					    <h2>{{ issuer.name }}</h2>
                        <small>{{ badgeclass_count }} {% if badgeclass_count > 1 %}Badges{% else %}Badge{% endif %}</small>
				    </div>
			    </a>


			    <p class="heading-x-meta">Issued {{ badge_instance.created_at|date:'F d, Y' }} to {{ obscured_recipient }}</p>

			    <p>{{ badge_class.description }}</p>

			     {% if badge_class.criteria_text %}
				     <h3 class="title title-small">Criteria</h3>

                     <div class="markdowneditor">
                        <div class="markdowneditor-x-display">
                            {{ badge_class.criteria_text|markdownify|safe }}
                        </div>
                     </div>
			     {% endif %}

		    {% if badge_instance.cached_evidence|length > 0 or badge_instance.narrative %}
			    <h3 class="title title-small">Evidence</h3>
			    {% if badge_instance.narrative %}
				    {{ badge_instance.narrative|markdownify|safe }}
				  {% endif %}
			    {% for evidence in badge_instance.cached_evidence %}
				    <div class="bordered l-padding-2x l-marginBottom-2x">
					    {% if evidence.narrative %}{{ evidence.narrative|markdownify|safe }}{% endif %}
					    {% if evidence.evidence_url %}
							<div class="l-childrenhorizontal l-childrenhorizontal-small l-childrenhorizontal-right">
									<a class="button button-primaryghost" href="{{ evidence.evidence_url }}">View Evidence URL</a>
							</div>
					    {% endif %}
				    </div>
			    {% endfor %}
		    {% endif %}

			    <div class="l-childrenhorizontal l-childrenhorizontal-small l-offsetleft">
				    {% if not badge_class.criteria_text %}
					    <a class="button button-primaryghost" href="{{ badge_class.criteria_url }}" target="_blank">View Criteria</a>
				    {% endif %}

			      {% if badge_instance_public_url %}
				    <a class="button button-primaryghost" href="{{ badge_instance_public_url }}" target="_blank">View JSON</a>
				    {% endif %}
				    {% if external_source_url %}
					    <a class="button button-primaryghost" href="{{ external_source_url }}" target="_blank">View Original</a>
				    {% endif %}
			    </div>

		    </div>

        <div class="heading-x-actions">
	    {% if action == 'download' %}
          <a id="ImageDownloadButton" class="button button-major button-large" target="_blank" href="{{ badge_instance_image_url }}" download>Download</a>
        {% elif badge_instance_public_url %}
          <a class="button button-major button-large" target="_blank" href="https://badgecheck.io/?url={{ badge_instance_public_url }}">Verify Badge</a>
		{% endif %}
        </div>

	    </div>

    </header>

		<div div class="wrap l-containerhorizontal l-headeredsection">
		</div>
	{% endif %}

{% endblock %}

{% block footer_extra_scripts %}
    {% if action == 'download' %}
        <script type="text/javascript">
            setTimeout(function(){
                var downloadButton = document.getElementById("ImageDownloadButton");
                downloadButton.click();
            }, 2000);
        </script>
    {% endif %}
{% endblock %}
